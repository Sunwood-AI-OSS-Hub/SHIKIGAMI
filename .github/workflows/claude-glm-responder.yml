name: CLAUDE_CODE_GLM_DEV

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened]

# åŒã˜Issue/PRã§ã¯åŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && (contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '@Claude') || contains(github.event.comment.body, '@CLAUDE'))) ||
      (github.event_name == 'pull_request_review_comment' && (contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '@Claude') || contains(github.event.comment.body, '@CLAUDE'))) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.body, '@Claude') || contains(github.event.issue.body, '@CLAUDE'))) ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰
    env:
      CREATE_AUTO_PR: "true"              # Issueã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼æ™‚ã«è‡ªå‹•ã§PRã‚’ä½œæˆã™ã‚‹ã‹ã©ã†ã‹
      INCLUDE_TASK_SUMMARY: "true"        # ã‚¿ã‚¹ã‚¯ã‚µãƒãƒªãƒ¼ï¼ˆ---ã‚ˆã‚Šå¾Œã‚ã®å ±å‘Šå†…å®¹ï¼‰ã‚’å«ã‚ã‚‹ã‹ã©ã†ã‹
      SOURCE_LOCATION: "remote"           # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚½ãƒ¼ã‚¹: local ã¾ãŸã¯ remote
      SOURCE_URL: "https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/refs/heads/main/.github/scripts/create-pr.py"
      LOCAL_PATH: '.github/scripts/create-pr.py'

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Checkout agents repository
        uses: actions/checkout@v4
        with:
          repository: Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox
          ref: main
          fetch-depth: 1
          path: .tmp/agents-repo

      - name: Install Claude agents into user directory
        shell: bash
        run: |
          set -euo pipefail

          SRC_DIR=".tmp/agents-repo/.github/.claude/agents"
          DEST_DIR="$HOME/.claude/agents"

          if [[ ! -d "$SRC_DIR" ]]; then
            echo "ERROR: Source agents directory not found: $SRC_DIR"
            exit 1
          fi

          mkdir -p "$DEST_DIR"
          # Copy agents from the checked out remote repository into the runner's user directory.
          cp -a "$SRC_DIR/." "$DEST_DIR/"
          echo "Installed agents:"
          ls -la "$DEST_DIR"

      # â˜…ã“ã“ã§ã€Œã“ã®å®Ÿè¡ŒãŒä½¿ã†ãƒ–ãƒ©ãƒ³ãƒåã€ã‚’æ±ºã‚æ‰“ã¡ã™ã‚‹
      - name: Compute branch name
        id: branch
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "name=claude-glm-dev-pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=claude-glm-dev-issue-${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: anthropics/claude-code-action@v1
        # Release-note issues often produce no git changes/branch, but the action can still
        # fail when it later tries to compare a non-existent branch. Allow continuation so
        # our "Create or Update Release" step can run.
        continue-on-error: ${{ (github.event_name == 'issue_comment' || github.event_name == 'issues') && startsWith(github.event.issue.title, 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ:') }}
        with:
          trigger_phrase: "@claude"

          # â˜…ãƒ–ãƒ©ãƒ³ãƒåã‚’å›ºå®šï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã—ï¼‰
          branch_prefix: ""
          branch_name_template: ${{ steps.branch.outputs.name }}

          # â˜…è¿½åŠ ï¼šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéç”¨ã«å¿…è¦
          anthropic_api_key: ${{ secrets.ZAI_API_KEY }}

          # æ—¥æœ¬èªå›ºå®š + Agent Teams å®Ÿè¡Œãƒ«ãƒ¼ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å†…éƒ¨ system prompt ã‚’æ½°ã•ãªã„ã‚ˆã† append ã‚’ä½¿ã†ï¼‰
          claude_args: |
            --append-system-prompt "ã€æœ€é‡è¦: å‡ºåŠ›è¨€èªã€‘ä»¥é™ã®å‡ºåŠ›ã¯æ—¥æœ¬èªã®ã¿ã§æ›¸ã„ã¦ãã ã•ã„ã€‚è‹±èªã®æ–‡ç« ã€è‹±èªè¦‹å‡ºã—ã€è‹±èªã®ç®‡æ¡æ›¸ãã€è‹±å˜èªã®æ··å…¥ã‚’ç¦æ­¢ã—ã¾ã™ã€‚ä¾‹å¤–ã¯ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã‚³ãƒ¼ãƒ‰ã€ã‚³ãƒãƒ³ãƒ‰ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã€å›ºæœ‰åè©ï¼ˆãƒªãƒã‚¸ãƒˆãƒªåã‚„ãƒ„ãƒ¼ãƒ«åãªã©ï¼‰ã§ã™ã€‚"
            --append-system-prompt "teammates é–“ã®ç›´æ¥ã‚„ã‚Šã¨ã‚Šè¦ç´„ã‚‚æ—¥æœ¬èªã®ã¿ã§æ›¸ã„ã¦ãã ã•ã„ã€‚"
            --append-system-prompt "ã€å‰æã€‘Agent Teams ã‚’ä½¿ã£ã¦ãã ã•ã„ï¼ˆsubagentsç¦æ­¢ï¼‰ã€‚teammateMode ã¯ in-process å‰æã§ã™ã€‚"
            --append-system-prompt "ã€å”èª¿è¦ä»¶ï¼ˆå¿…é ˆï¼‰ã€‘teammates åŒå£«ãŒæœ€ä½1å¾€å¾©ä»¥ä¸Šã¯ç›´æ¥ã‚„ã‚Šã¨ã‚Šã—ã€ç›¸äº’ã«ãƒ„ãƒƒã‚³ãƒŸ/è£œè¶³ã—ã¦ã‹ã‚‰çµ±åˆã—ã¦ãã ã•ã„ã€‚teammates é–“ã®ç›´æ¥ã‚„ã‚Šã¨ã‚Šè¦ç´„ã‚’å¿…ãšå‡ºã—ã¦ãã ã•ã„ï¼ˆèª°ãŒèª°ã«ä½•ã‚’è¨€ã£ãŸã‹ã‚’çŸ­ãï¼‰ã€‚"
            --append-system-prompt "ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚³ãƒ¡ãƒ³ãƒˆå…ˆé ­ã«å¿…é ˆã€‚ã“ã“ã‚‚æ—¥æœ¬èªã®ã¿ï¼‰ã€‘Agent Teams ä½¿ç”¨: ã¯ã„/ã„ã„ãˆã€‚teammateMode: in-processã€‚ã‚¹ãƒãƒ¼ãƒ³ã—ãŸ teammates: å½¹å‰² + äººæ•°ã€‚è¨¼æ‹ : teammates é–“ã®ç›´æ¥ã‚„ã‚Šã¨ã‚Šè¦ç´„ã€‚å…±æœ‰ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ: èª°ãŒä½•ã‚’æ‹…å½“ã—å®Œäº†ã—ãŸã‹ã€‚"
            --append-system-prompt "ãã®å¾Œã«ã€å®Ÿè£…å†…å®¹ã®æ¦‚è¦ãƒ»å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ†ã‚¹ãƒˆçµæœã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«æ›¸ã„ã¦ãã ã•ã„ã€‚"
            --append-system-prompt "ã€çµ‚äº†æ¡ä»¶ã€‘ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸã‚‰ã€æœ€å¾Œã«ã€Œã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ ã‚’è§£æ•£ã—ãŸã€ã“ã¨ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚"
            --append-system-prompt "ã€è¿½åŠ æŒ‡ç¤ºã€‘ç¾æ™‚ç‚¹ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¿½åŠ ã®æŒ‡ç¤ºã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ å¯¾å¿œã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æ–°ãŸãªæŒ‡ç¤ºãŒæ¥ãŸå ´åˆã«ã®ã¿è¡Œã£ã¦ãã ã•ã„ã€‚"

        env:
          # Agent Teams (Experimental): CI ã§ã¯ tmux ãŒä½¿ãˆãªã„ã®ã§ in-process ã‚’å¼·åˆ¶
          CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS: "1"
          # NOTE: High retry counts can cause repeated Claude Code re-inits even after success.
          # Keep this low to avoid "init/result" loops in CI logs.
          CLAUDE_CODE_MAX_RETRIES: "1"
          teammateMode: "in-process"
          LANG: "ja_JP.UTF-8"
          LC_ALL: "ja_JP.UTF-8"
          # GLMã«å‘ã‘ã‚‹è¨­å®š
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZAI_API_KEY }}
          API_TIMEOUT_MS: "3000000"
          ANTHROPIC_DEFAULT_OPUS_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_SONNET_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_HAIKU_MODEL: "glm-4.5-air"
          # When investigating intermittent failures, enable SDK stderr logs.
          DEBUG_CLAUDE_AGENT_SDK: "1"
          # gh CLI ã‚’ä½¿ã£ãŸ Release ä½œæˆ/æ›´æ–°ã«å¿…è¦
          GH_TOKEN: ${{ github.token }}

      # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”ŸæˆIssueã®å ´åˆã¯ã€ClaudeãŒä¿å­˜ã—ãŸãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Releaseã‚’è‡ªå‹•ä½œæˆ/æ›´æ–°ã™ã‚‹
      - name: Create or Update Release (release-note issues)
        if: |
          (github.event_name == 'issue_comment' || github.event_name == 'issues') &&
          startsWith(github.event.issue.title, 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ:')
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          TITLE="${{ github.event.issue.title }}"
          TAG_NAME="${TITLE#ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ: }"
          TAG_NAME="$(echo "$TAG_NAME" | sed -E 's/^ +//; s/ +$//')"

          echo "Release tag: $TAG_NAME"

          # Claudeå´ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã¯æºã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€å€™è£œã‚’é †ã«æ¢ã™
          NOTES_CANDIDATES=(
            "/tmp/release-notes-${TAG_NAME}.md"
            "/tmp/release-notes-${TAG_NAME}.markdown"
            "/tmp/release-notes.md"
          )

          NOTES_FILE=""
          for f in "${NOTES_CANDIDATES[@]}"; do
            if [[ -f "$f" ]]; then
              NOTES_FILE="$f"
              break
            fi
          done

          if [[ -z "$NOTES_FILE" ]]; then
            echo "ERROR: Release notes file not found. Looked for:"
            printf '  - %s\n' "${NOTES_CANDIDATES[@]}"
            exit 1
          fi

          echo "Using notes file: $NOTES_FILE"
          ls -la "$NOTES_FILE"

          RELEASE_TITLE="ğŸ‰ ${TAG_NAME}"
          echo "Release title: $RELEASE_TITLE"

          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            gh release edit "$TAG_NAME" --title "$RELEASE_TITLE" --notes-file "$NOTES_FILE"
          else
            gh release create "$TAG_NAME" --title "$RELEASE_TITLE" --notes-file "$NOTES_FILE"
          fi

      # â˜…Issueã‹ã‚‰ãƒˆãƒªã‚¬ãƒ¼ã•ã‚ŒãŸå ´åˆã®ã¿ã€è‡ªå‹•ã§PRã‚’ä½œæˆ
      # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆç”¨ã®Issueã¯PRã‚’ä½œæˆã—ãªã„
      - name: Create PR (if from issue)
        if: |
          github.event_name == 'issues' &&
          !startsWith(github.event.issue.title, 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ')
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_ONIZUKA }}
        run: |
          # ç’°å¢ƒå¤‰æ•°ã§PRä½œæˆã‚’åˆ¶å¾¡
          if [[ "${{ env.CREATE_AUTO_PR }}" != "true" ]]; then
            echo "CREATE_AUTO_PR is not true. Skipping PR creation."
            exit 0
          fi

          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/ãƒªãƒ¢ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼‰
          if [[ "${{ env.SOURCE_LOCATION }}" == "remote" ]]; then
            if [[ -z "${{ env.SOURCE_URL }}" ]]; then
              echo "ERROR: SOURCE_LOCATION=remote but SOURCE_URL is not set!"
              exit 1
            fi
            echo "Downloading script from remote..."
            curl -fsSL "${{ env.SOURCE_URL }}" -o /tmp/create-pr.py
            python3 /tmp/create-pr.py \
              "${{ steps.branch.outputs.name }}" \
              "${{ github.event.issue.number }}"
          else
            echo "Using local script..."
            python3 "${{ env.LOCAL_PATH }}" \
              "${{ steps.branch.outputs.name }}" \
              "${{ github.event.issue.number }}"
          fi
